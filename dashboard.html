<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Planning Ritual Stats</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        :root {
            --background: 0 0% 100%;
            --foreground: 224 71.4% 4.1%;
            --card: 0 0% 100%;
            --card-foreground: 224 71.4% 4.1%;
            --popover: 0 0% 100%;
            --popover-foreground: 224 71.4% 4.1%;
            --primary: 220.9 39.3% 11%;
            --primary-foreground: 210 20% 98%;
            --secondary: 220 14.3% 95.9%;
            --secondary-foreground: 220.9 39.3% 11%;
            --muted: 220 14.3% 95.9%;
            --muted-foreground: 220 8.9% 46.1%;
            --accent: 220 14.3% 95.9%;
            --accent-foreground: 220.9 39.3% 11%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 20% 98%;
            --border: 220 13% 91%;
            --input: 220 13% 91%;
            --ring: 224 71.4% 4.1%;
            --radius: 0.5rem;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: hsl(var(--background));
            color: hsl(var(--foreground));
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Card styles matching shadcn/ui */
        .card {
            background: hsl(var(--card));
            color: hsl(var(--card-foreground));
            border-radius: calc(var(--radius) + 2px);
            border: 1px solid hsl(var(--border));
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        
        .card:hover {
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: box-shadow 0.2s;
        }
        
        /* Remove all scrollbars */
        html, body {
            overflow-x: hidden;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const SUPABASE_URL = 'https://yazzzpyohcdyvtdpjakb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlhenp6cHlvaGNkeXZ0ZHBqYWtiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4NjIwOTksImV4cCI6MjA2NTQzODA5OX0.GnrnIlTJIw4VqKm4bHBAkO5vXJ1aWyrVL5oxIl1lCwA';

        function Dashboard() {
            const [sessions, setSessions] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                fetchSessions();
                const interval = setInterval(fetchSessions, 300000);
                return () => clearInterval(interval);
            }, []);

            const fetchSessions = async () => {
                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/planning_sessions?select=*&order=date.desc`, {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    });
                    const data = await response.json();
                    setSessions(data || []);
                    setLoading(false);
                } catch (error) {
                    console.error('Error loading sessions:', error);
                    setLoading(false);
                }
            };

            const calculateMetrics = () => {
                const totalWeeks = sessions.length;
                const consecutiveWeeks = calculateConsecutive(sessions);
                const totalMinutes = sessions.reduce((sum, s) => sum + (s.ritual_duration_minutes || s.minutes || 0), 0);
                const avgMinutes = totalWeeks > 0 ? Math.round(totalMinutes / totalWeeks) : 0;
                
                const weeksAllTasksCompleted = sessions.filter(s => s.tasks_completed).length;
                const consecutiveTasksCompleted = calculateConsecutiveCompleted(sessions);
                
                let totalTasksPlanned = 0;
                sessions.forEach(s => {
                    if (s.task1) totalTasksPlanned++;
                    if (s.task2) totalTasksPlanned++;
                    if (s.task3) totalTasksPlanned++;
                });
                
                const quarterlyQuests = Math.floor(totalWeeks / 12);

                return {
                    totalWeeks,
                    consecutiveWeeks,
                    totalMinutes,
                    avgMinutes,
                    weeksAllTasksCompleted,
                    consecutiveTasksCompleted,
                    totalTasksPlanned,
                    quarterlyQuests
                };
            };

            const calculateConsecutive = (sessions) => {
                if (sessions.length === 0) return 0;
                let count = 1;
                const sorted = [...sessions].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                for (let i = 1; i < sorted.length; i++) {
                    const diff = (new Date(sorted[i-1].date) - new Date(sorted[i].date)) / (1000 * 60 * 60 * 24);
                    if (diff <= 7) count++;
                    else break;
                }
                return count;
            };

            const calculateConsecutiveCompleted = (sessions) => {
                if (sessions.length === 0) return 0;
                let count = 0;
                const sorted = [...sessions].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                for (let i = 0; i < sorted.length; i++) {
                    if (sorted[i].tasks_completed) count++;
                    else break;
                }
                return count;
            };

            const metrics = calculateMetrics();

            if (loading) {
                return (
                    <div className="flex min-h-screen items-center justify-center p-4">
                        <div className="text-center">
                            <div className="mb-4 h-8 w-8 animate-spin rounded-full border-2 border-gray-300 border-t-gray-600 mx-auto"></div>
                            <p className="text-sm text-gray-500">Loading analytics...</p>
                        </div>
                    </div>
                );
            }

            const cards = [
                {
                    label: "Total weeks",
                    value: metrics.totalWeeks,
                },
                {
                    label: "Consecutive weeks",
                    value: metrics.consecutiveWeeks,
                },
                {
                    label: "Total minutes",
                    value: metrics.totalMinutes,
                },
                {
                    label: "Avg minutes",
                    value: metrics.avgMinutes,
                },
                {
                    label: "Weeks all tasks done",
                    value: metrics.weeksAllTasksCompleted,
                },
                {
                    label: "Consecutive all tasks",
                    value: metrics.consecutiveTasksCompleted,
                },
                {
                    label: "Total tasks done",
                    value: metrics.totalTasksPlanned,
                },
                {
                    label: "Quarterly quests",
                    value: metrics.quarterlyQuests,
                }
            ];

            return (
                <div className="min-h-screen p-4 md:p-6 lg:p-8">
                    <div className="mx-auto max-w-6xl">
                        <div className="mb-8">
                            <h1 className="text-2xl font-semibold tracking-tight">
                                Weekly Planning Ritual Stats
                            </h1>
                        </div>

                        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
                            {cards.map((card, index) => (
                                <div key={index} className="card p-6">
                                    <div className="text-sm text-gray-500">
                                        {card.label}
                                    </div>
                                    <div className="mt-2 text-2xl font-semibold">
                                        {card.value}
                                    </div>
                                </div>
                            ))}
                        </div>

                        <div className="mt-6 text-center">
                            <p className="text-sm text-gray-500">
                                Last updated: {new Date().toLocaleString('en-US', {
                                    month: 'numeric',
                                    day: 'numeric',
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}
                            </p>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<Dashboard />, document.getElementById('root'));
    </script>
</body>
</html>
