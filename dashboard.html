<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planungsritual Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Supabase Config
        const SUPABASE_URL = 'https://yazzzpyohcdyvtdpjakb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlhenp6cHlvaGNkeXZ0ZHBqYWtiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4NjIwOTksImV4cCI6MjA2NTQzODA5OX0.GnrnIlTJIw4VqKm4bHBAkO5vXJ1aWyrVL5oxIl1lCwA';

        function Dashboard() {
          const [sessions, setSessions] = useState([]);
          const [loading, setLoading] = useState(true);

          useEffect(() => {
            fetchSessions();
            // Refresh every 5 minutes
            const interval = setInterval(fetchSessions, 300000);
            return () => clearInterval(interval);
          }, []);

          const fetchSessions = async () => {
            try {
              const response = await fetch(`${SUPABASE_URL}/rest/v1/planning_sessions?select=*&order=date.desc`, {
                headers: {
                  'apikey': SUPABASE_ANON_KEY,
                  'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                }
              });
              const data = await response.json();
              setSessions(data || []);
              setLoading(false);
            } catch (error) {
              console.error('Error loading sessions:', error);
              setLoading(false);
            }
          };

          const calculateMetrics = () => {
            const totalWeeks = sessions.length;
            const consecutiveWeeks = calculateConsecutive(sessions);
            
            // Use ritual_duration_minutes if available, fallback to minutes field
            const totalMinutes = sessions.reduce((sum, s) => sum + (s.ritual_duration_minutes || s.minutes || 0), 0);
            const avgMinutes = totalWeeks > 0 ? Math.round(totalMinutes / totalWeeks) : 0;
            
            const weeksAllTasksCompleted = sessions.filter(s => s.tasks_completed).length;
            const consecutiveTasksCompleted = calculateConsecutiveCompleted(sessions);
            const totalTasksCompleted = sessions.reduce((sum, s) => {
              let count = 0;
              if (s.task1) count++;
              if (s.task2) count++;
              if (s.task3) count++;
              return sum + count;
            }, 0);
            
            // Quarterly quests (assuming 1 quest per 12 weeks)
            const quarterlyQuests = Math.floor(totalWeeks / 12);

            // Sessions with time tracking
            const sessionsWithTimeTracking = sessions.filter(s => s.ritual_duration_minutes).length;

            return {
              totalWeeks,
              consecutiveWeeks,
              totalMinutes,
              avgMinutes,
              weeksAllTasksCompleted,
              consecutiveTasksCompleted,
              totalTasksCompleted,
              quarterlyQuests,
              sessionsWithTimeTracking
            };
          };

          const calculateConsecutive = (sessions) => {
            if (sessions.length === 0) return 0;
            let count = 1;
            const sorted = [...sessions].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            for (let i = 1; i < sorted.length; i++) {
              const diff = (new Date(sorted[i-1].date) - new Date(sorted[i].date)) / (1000 * 60 * 60 * 24);
              if (diff <= 7) count++;
              else break;
            }
            return count;
          };

          const calculateConsecutiveCompleted = (sessions) => {
            if (sessions.length === 0) return 0;
            let count = 0;
            const sorted = [...sessions].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            for (let i = 0; i < sorted.length; i++) {
              if (sorted[i].tasks_completed) count++;
              else break;
            }
            return count;
          };

          const metrics = calculateMetrics();

          if (loading) {
            return (
              <div className="min-h-screen bg-transparent flex items-center justify-center">
                <p className="text-gray-600">Loading dashboard...</p>
              </div>
            );
          }

          return (
            <div className="bg-transparent py-4">
              <div className="max-w-7xl mx-auto px-4">
                <h2 className="text-2xl font-bold text-gray-900 mb-6 text-center">
                  Weekly Planning Ritual Stats
                </h2>
                
                <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                  <div className="bg-white border border-gray-200 rounded-lg p-4 text-center shadow-sm">
                    <p className="text-xs text-gray-600 mb-1">Total weeks</p>
                    <p className="text-3xl font-bold text-blue-600">{metrics.totalWeeks}</p>
                  </div>
                  
                  <div className="bg-white border border-gray-200 rounded-lg p-4 text-center shadow-sm">
                    <p className="text-xs text-gray-600 mb-1">Consecutive weeks</p>
                    <p className="text-3xl font-bold text-green-600">{metrics.consecutiveWeeks}</p>
                  </div>
                  
                  <div className="bg-white border border-gray-200 rounded-lg p-4 text-center shadow-sm">
                    <p className="text-xs text-gray-600 mb-1">Total minutes</p>
                    <p className="text-3xl font-bold text-purple-600">{metrics.totalMinutes}</p>
                  </div>
                  
                  <div className="bg-white border border-gray-200 rounded-lg p-4 text-center shadow-sm">
                    <p className="text-xs text-gray-600 mb-1">Avg minutes</p>
                    <p className="text-3xl font-bold text-indigo-600">{metrics.avgMinutes}</p>
                  </div>
                  
                  <div className="bg-white border border-gray-200 rounded-lg p-4 text-center shadow-sm">
                    <p className="text-xs text-gray-600 mb-1">Weeks all tasks done</p>
                    <p className="text-3xl font-bold text-yellow-600">{metrics.weeksAllTasksCompleted}</p>
                  </div>
                  
                  <div className="bg-white border border-gray-200 rounded-lg p-4 text-center shadow-sm">
                    <p className="text-xs text-gray-600 mb-1">Consecutive all tasks</p>
                    <p className="text-3xl font-bold text-red-600">{metrics.consecutiveTasksCompleted}</p>
                  </div>
                  
                  <div className="bg-white border border-gray-200 rounded-lg p-4 text-center shadow-sm">
                    <p className="text-xs text-gray-600 mb-1">Total tasks done</p>
                    <p className="text-3xl font-bold text-teal-600">{metrics.totalTasksCompleted}</p>
                  </div>
                  
                  <div className="bg-white border border-gray-200 rounded-lg p-4 text-center shadow-sm">
                    <p className="text-xs text-gray-600 mb-1">Quarterly quests</p>
                    <p className="text-3xl font-bold text-orange-600">{metrics.quarterlyQuests}</p>
                  </div>
                </div>

                <div className="mt-4 text-center text-xs text-gray-500">
                  Last updated: {new Date().toLocaleString('en-US')}
                </div>
              </div>
            </div>
          );
        }

        ReactDOM.render(<Dashboard />, document.getElementById('root'));
    </script>
</body>
</html>
