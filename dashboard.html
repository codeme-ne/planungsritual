<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Planning Ritual - Analytics</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;
            --primary: 221.2 83.2% 53.3%;
            --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96.1%;
            --secondary-foreground: 222.2 47.4% 11.2%;
            --muted: 210 40% 96.1%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96.1%;
            --accent-foreground: 222.2 47.4% 11.2%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 221.2 83.2% 53.3%;
            --radius: 0.5rem;
        }
        
        * {
            border-color: hsl(var(--border));
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: hsl(var(--muted));
        }
        
        ::-webkit-scrollbar-thumb {
            background: hsl(var(--muted-foreground) / 0.3);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: hsl(var(--muted-foreground) / 0.5);
        }
        
        /* Smooth animations */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-slide-up {
            animation: slideUp 0.3s ease-out forwards;
        }
        
        /* Area chart styles */
        .chart-area {
            fill: hsl(var(--primary) / 0.1);
            stroke: hsl(var(--primary));
            stroke-width: 2;
        }
        
        .chart-grid {
            stroke: hsl(var(--border));
            stroke-width: 1;
            opacity: 0.5;
        }
    </style>
</head>
<body className="min-h-screen bg-background">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Supabase Config
        const SUPABASE_URL = 'https://yazzzpyohcdyvtdpjakb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlhenp6cHlvaGNkeXZ0ZHBqYWtiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4NjIwOTksImV4cCI6MjA2NTQzODA5OX0.GnrnIlTJIw4VqKm4bHBAkO5vXJ1aWyrVL5oxIl1lCwA';

        // Simple Area Chart Component
        function AreaChart({ data, width = 800, height = 300 }) {
            if (!data || data.length === 0) return null;
            
            const padding = { top: 20, right: 30, bottom: 40, left: 50 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;
            
            // Find min and max values
            const minutes = data.map(d => d.minutes);
            const maxMinutes = Math.max(...minutes);
            const minMinutes = Math.min(...minutes);
            
            // Create scales
            const xScale = (index) => (index / (data.length - 1)) * chartWidth;
            const yScale = (value) => chartHeight - ((value - minMinutes) / (maxMinutes - minMinutes)) * chartHeight;
            
            // Create path
            const pathData = data.map((d, i) => {
                const x = xScale(i);
                const y = yScale(d.minutes);
                return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
            }).join(' ');
            
            // Create area path
            const areaPath = pathData + ` L ${chartWidth} ${chartHeight} L 0 ${chartHeight} Z`;
            
            return (
                <div className="w-full overflow-x-auto">
                    <svg width={width} height={height} className="overflow-visible">
                        <g transform={`translate(${padding.left}, ${padding.top})`}>
                            {/* Grid lines */}
                            {[0, 0.25, 0.5, 0.75, 1].map(i => {
                                const y = i * chartHeight;
                                return (
                                    <line
                                        key={i}
                                        x1={0}
                                        y1={y}
                                        x2={chartWidth}
                                        y2={y}
                                        className="chart-grid"
                                    />
                                );
                            })}
                            
                            {/* Area */}
                            <path d={areaPath} className="chart-area" opacity="0.1" />
                            
                            {/* Line */}
                            <path d={pathData} fill="none" className="chart-area" />
                            
                            {/* Data points */}
                            {data.map((d, i) => (
                                <g key={i}>
                                    <circle
                                        cx={xScale(i)}
                                        cy={yScale(d.minutes)}
                                        r="4"
                                        fill="hsl(var(--primary))"
                                        className="cursor-pointer hover:r-6 transition-all"
                                    >
                                        <title>{`${d.week}: ${d.minutes} minutes`}</title>
                                    </circle>
                                </g>
                            ))}
                            
                            {/* X-axis labels */}
                            {data.map((d, i) => {
                                if (i % Math.ceil(data.length / 6) === 0 || i === data.length - 1) {
                                    return (
                                        <text
                                            key={i}
                                            x={xScale(i)}
                                            y={chartHeight + 20}
                                            textAnchor="middle"
                                            className="text-xs fill-muted-foreground"
                                        >
                                            {d.week}
                                        </text>
                                    );
                                }
                                return null;
                            })}
                            
                            {/* Y-axis labels */}
                            {[0, 0.5, 1].map(i => {
                                const value = Math.round(minMinutes + (maxMinutes - minMinutes) * (1 - i));
                                return (
                                    <text
                                        key={i}
                                        x={-10}
                                        y={i * chartHeight + 5}
                                        textAnchor="end"
                                        className="text-xs fill-muted-foreground"
                                    >
                                        {value}
                                    </text>
                                );
                            })}
                        </g>
                    </svg>
                </div>
            );
        }

        function Dashboard() {
            const [sessions, setSessions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isExpanded, setIsExpanded] = useState(false);

            useEffect(() => {
                fetchSessions();
                const interval = setInterval(fetchSessions, 300000);
                return () => clearInterval(interval);
            }, []);

            const fetchSessions = async () => {
                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/planning_sessions?select=*&order=date.desc`, {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    });
                    const data = await response.json();
                    setSessions(data || []);
                    setLoading(false);
                } catch (error) {
                    console.error('Error loading sessions:', error);
                    setLoading(false);
                }
            };

            const calculateMetrics = () => {
                const totalWeeks = sessions.length;
                const consecutiveWeeks = calculateConsecutive(sessions);
                const totalMinutes = sessions.reduce((sum, s) => sum + (s.ritual_duration_minutes || s.minutes || 0), 0);
                const avgMinutes = totalWeeks > 0 ? Math.round(totalMinutes / totalWeeks) : 0;
                
                const weeksAllTasksCompleted = sessions.filter(s => s.tasks_completed).length;
                const consecutiveTasksCompleted = calculateConsecutiveCompleted(sessions);
                
                let totalTasksPlanned = 0;
                sessions.forEach(s => {
                    if (s.task1) totalTasksPlanned++;
                    if (s.task2) totalTasksPlanned++;
                    if (s.task3) totalTasksPlanned++;
                });
                
                const quarterlyQuests = Math.floor(totalWeeks / 12);
                const completionRate = totalWeeks > 0 ? Math.round((weeksAllTasksCompleted / totalWeeks) * 100) : 0;

                return {
                    totalWeeks,
                    consecutiveWeeks,
                    totalMinutes,
                    avgMinutes,
                    weeksAllTasksCompleted,
                    consecutiveTasksCompleted,
                    totalTasksPlanned,
                    quarterlyQuests,
                    completionRate
                };
            };

            const calculateConsecutive = (sessions) => {
                if (sessions.length === 0) return 0;
                let count = 1;
                const sorted = [...sessions].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                for (let i = 1; i < sorted.length; i++) {
                    const diff = (new Date(sorted[i-1].date) - new Date(sorted[i].date)) / (1000 * 60 * 60 * 24);
                    if (diff <= 7) count++;
                    else break;
                }
                return count;
            };

            const calculateConsecutiveCompleted = (sessions) => {
                if (sessions.length === 0) return 0;
                let count = 0;
                const sorted = [...sessions].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                for (let i = 0; i < sorted.length; i++) {
                    if (sorted[i].tasks_completed) count++;
                    else break;
                }
                return count;
            };

            // Prepare chart data
            const getChartData = () => {
                return sessions
                    .slice(0, 12)
                    .reverse()
                    .map(session => ({
                        week: new Date(session.date).toLocaleDateString('en-US', { 
                            month: 'short',
                            day: 'numeric'
                        }),
                        minutes: session.ritual_duration_minutes || session.minutes || 0
                    }));
            };

            const metrics = calculateMetrics();
            const chartData = getChartData();

            if (loading) {
                return (
                    <div className="flex h-screen items-center justify-center">
                        <div className="text-center">
                            <div className="h-8 w-8 animate-spin rounded-full border-4 border-primary border-t-transparent mx-auto mb-4"></div>
                            <p className="text-muted-foreground">Loading analytics...</p>
                        </div>
                    </div>
                );
            }

            const metricCards = [
                {
                    title: "Total weeks",
                    value: metrics.totalWeeks,
                    color: "text-foreground"
                },
                {
                    title: "Consecutive weeks",
                    value: metrics.consecutiveWeeks,
                    color: "text-green-600",
                    highlight: metrics.consecutiveWeeks >= 5
                },
                {
                    title: "Total minutes",
                    value: metrics.totalMinutes,
                    color: "text-foreground"
                },
                {
                    title: "Avg minutes",
                    value: metrics.avgMinutes,
                    color: "text-foreground"
                },
                {
                    title: "Weeks all tasks done",
                    value: metrics.weeksAllTasksCompleted,
                    color: "text-foreground"
                },
                {
                    title: "Consecutive all tasks",
                    value: metrics.consecutiveTasksCompleted,
                    color: "text-foreground"
                },
                {
                    title: "Total tasks done",
                    value: metrics.totalTasksPlanned,
                    color: "text-foreground"
                },
                {
                    title: "Quarterly quests",
                    value: metrics.quarterlyQuests,
                    color: "text-foreground"
                }
            ];

            return (
                <div className="min-h-screen bg-background">
                    <div className="container mx-auto p-4 md:p-6 lg:p-8 max-w-7xl">
                        {/* Header */}
                        <div className="mb-8 animate-slide-up">
                            <h1 className="text-3xl font-bold tracking-tight mb-2">Weekly Planning Ritual Stats</h1>
                            <p className="text-muted-foreground">
                                Track your consistency and progress in weekly planning
                            </p>
                        </div>

                        {/* Info Section */}
                        <div className="mb-8 animate-slide-up" style={{ animationDelay: '0.1s' }}>
                            <div className="rounded-lg border bg-card p-6">
                                <div className="flex items-center justify-between mb-4">
                                    <h2 className="text-lg font-semibold">About this dashboard</h2>
                                    <button
                                        onClick={() => setIsExpanded(!isExpanded)}
                                        className="text-sm text-muted-foreground hover:text-foreground transition-colors"
                                    >
                                        {isExpanded ? 'Show less' : 'Learn more'}
                                    </button>
                                </div>
                                
                                <p className="text-sm text-muted-foreground mb-3">
                                    I'm developing programming tools that streamline my daily routines and enhance personal accountability. 
                                    This dashboard displays real-time data from my weekly planning ritualâ€”a structured 30-minute reflection 
                                    and planning session I complete every week.
                                </p>

                                {isExpanded && (
                                    <div className="space-y-4 mt-4 pt-4 border-t">
                                        <div>
                                            <h3 className="font-medium mb-2">How it works</h3>
                                            <p className="text-sm text-muted-foreground mb-2">
                                                The app is a Progressive Web App (PWA) installed directly on my phone's home screen. 
                                                It guides me through a focused three-step process:
                                            </p>
                                            <ol className="list-decimal list-inside text-sm text-muted-foreground space-y-1 ml-2">
                                                <li><strong>Quarterly Goal Alignment:</strong> Review progress and course-correct if needed</li>
                                                <li><strong>Weekly Reflection:</strong> Celebrate wins and identify learnings</li>
                                                <li><strong>Action Planning:</strong> Define 1-3 high-leverage tasks with specific dates</li>
                                            </ol>
                                        </div>

                                        <div>
                                            <h3 className="font-medium mb-2">Dashboard Metrics Explained</h3>
                                            <dl className="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                                                <div>
                                                    <dt className="font-medium text-muted-foreground">Total weeks</dt>
                                                    <dd className="text-muted-foreground">Weekly planning sessions completed since starting</dd>
                                                </div>
                                                <div>
                                                    <dt className="font-medium text-muted-foreground">Consecutive weeks</dt>
                                                    <dd className="text-muted-foreground">Current streak of unbroken weekly sessions</dd>
                                                </div>
                                                <div>
                                                    <dt className="font-medium text-muted-foreground">Total/Avg minutes</dt>
                                                    <dd className="text-muted-foreground">Time invested in planning and average duration</dd>
                                                </div>
                                                <div>
                                                    <dt className="font-medium text-muted-foreground">Weeks all tasks done</dt>
                                                    <dd className="text-muted-foreground">Weeks where all 3 planned tasks were completed</dd>
                                                </div>
                                                <div>
                                                    <dt className="font-medium text-muted-foreground">Total tasks done</dt>
                                                    <dd className="text-muted-foreground">Cumulative count of planned tasks</dd>
                                                </div>
                                                <div>
                                                    <dt className="font-medium text-muted-foreground">Quarterly quests</dt>
                                                    <dd className="text-muted-foreground">Completed 12-week planning cycles</dd>
                                                </div>
                                            </dl>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Metrics Grid */}
                        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4 mb-8">
                            {metricCards.map((metric, index) => (
                                <div
                                    key={index}
                                    className={`rounded-lg border bg-card p-6 animate-slide-up ${
                                        metric.highlight ? 'ring-2 ring-green-600 ring-offset-2 ring-offset-background' : ''
                                    }`}
                                    style={{ animationDelay: `${0.2 + index * 0.05}s` }}
                                >
                                    <p className="text-sm font-medium text-muted-foreground">{metric.title}</p>
                                    <p className={`text-3xl font-bold ${metric.color} mt-2`}>
                                        {metric.value}
                                    </p>
                                    {metric.title === "Consecutive weeks" && metrics.consecutiveWeeks >= 5 && (
                                        <p className="text-xs text-green-600 mt-1">ðŸ”¥ On fire!</p>
                                    )}
                                </div>
                            ))}
                        </div>

                        {/* Chart Section */}
                        {chartData.length > 0 && (
                            <div className="rounded-lg border bg-card p-6 animate-slide-up" style={{ animationDelay: '0.6s' }}>
                                <h3 className="text-lg font-semibold mb-4">Ritual Duration Trend</h3>
                                <div className="w-full">
                                    <AreaChart data={chartData} width={Math.min(800, window.innerWidth - 100)} height={300} />
                                </div>
                            </div>
                        )}

                        {/* Footer */}
                        <div className="mt-8 text-center text-sm text-muted-foreground animate-slide-up" style={{ animationDelay: '0.7s' }}>
                            <p>Last updated: {new Date().toLocaleString('en-US')}</p>
                            <p className="mt-1">Automatically refreshes every 5 minutes</p>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<Dashboard />, document.getElementById('root'));
    </script>
</body>
</html>
